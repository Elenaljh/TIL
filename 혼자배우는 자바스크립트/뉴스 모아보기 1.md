# 뉴스 모아보기 홈피 만들기 1
## 1. JS에서 api 불러오기
### 1. 자바스크립트의 동작원리
```js
console.log(1)
//시간지연시키는 함수
//setTimeout(함수, ms)
//1000ms = 1s
setTimeout(()=>{
  console.log(2)
}, 2000)
console.log(3)

//결과: 1 3 (2초 후) 2
//이런 결과가 나온 이유(js 동작원리)
// 동기적 프로그래밍: js에는 stack(thread)이 딱 하나밖에 없기 때문에 주어진 코드를 순차적으로 처리한다
//setTimeout이 순차적으로 처리되지 않는 이유: setTimeout처럼 바로 처리할 수 없는 코드는 대기실(web api->백그라운드)에 잠깐 보내놓음. 그리고 2초(사용자 설정에 따라 달라지긴 함)가 지나면 인자로 받은 함수(이 경우 console.log(2))를 바로 stack으로 보내지는 못하고 que로 보냄. 그리고 stack이 바쁜지 안바쁜지 체크하고 있다가 바쁘지 않을 때 console.log(2)를 스택으로 보내고, stack은 console.log(2)를 처리하게 됨.
//백그라운드에서 기다리는 함수: setTimeout, ajax(같이 서버에 뭔가를 요청하는 코드), eventListener(사용자가 event를 실행할때까지 기다려야 함) 등 실행하는데 시간이 오래 걸리는 애들
```

### 2. JS로 api 받아오기
#### 코드 순서
1. url 준비
2. 헤더 준비
3. 백엔드 서버에 요청
4. 데이터를 보여줌
- 3번을 실행하는 데 오래 걸리기 때문에 3번 코드는 백그라운드로 이동하고 4번 코드가 스택으로 가서 실행된다. 그런데 백엔드 서버에 요청하는 작업이 끝나지 않은 상태에서 데이터를 보여줄 수 없으므로 ERROR가 발생한다.
- 이 문제를 해결하기 위해 3번 코드가 모두 실행되기 전까지 4번 코드의 실행을 막아야 한다. 이 때 사용되는 것이 `async.await`이다.    
<img src = "https://i.esdrop.com/d/f/Hn3cQpRVXY/luCKZrsZRE.gif">   
    
```js
const  getLatestNews  =  async ()=>{
// API URL
let  url  =  new  URL("https://api.newscatcherapi.com/v2/latest_headlines?countries=KR&topic=politics&page_size=10");

// KEY
let  header  =  new  Headers({'x-api-key':  'Ti97npC1fqIJ5h_9RcQTcU-Koe4A0Sus3gi2kZmzCD4'});

// 응답받기
let  response  =  await  fetch(url, {headers:  header}); //데이터를 보내는 함수: ajax, axios, fetch
//await으로 강제로 fetch함수를 기다려준다. await을 하기 위해선 함수를 async로 만들어줘야함(이 함수에서 비동기처리를 할 것임을 알려주는 것)
//async와 await은 짝을 이룬다. 
let  data  =  await  response.json() //response에서 json데이터를 뽑아내 저장한다. 이것도 시간이 많이 걸리는 작업이기 때문에 await을 걸어준다.
console.log(response);
}

//URL, Headers 클래스를 new라는 키워드를 이용해 객체 생성
getLatestNews();
```    

참고: `await`를 사용하지 않고 그냥 `fetch`만 사용해서 데이터를 불러오는 경우 `promise{<pending>}`가 콘솔창에 뜬다. status:pending은 아직 데이터가 도착하지 않음을 뜻함. promise는 따로 공부하기 (강의자료 다 읽어보기! 좋은게 많다!)

## 2. 홈페이지 레이아웃 만들기

html과 css (+bootstrap)을 이용해 홈페이지의 아웃라인을 만든다

## 3. 자바스크립트 코드 치기
*참고
나중에 헷갈릴까봐 쓰는건데 render()은 사용자 정의 함수로 탭을 클릭할 때마다, 검색 조건을 바꿀 때마다 조건을 적용해서 페이지를 계속 업데이트해주는 함수이다. (TodoList 만들 때도 썼었음)

#### 이제 쭉.. 코드 치기
<details>
<summary>코드 리펙토링 전의 js코드 보기</summary>  

```js
let  news  = [];
let  menus  =  document.querySelectorAll(".menus button"); 

menus.forEach(menu  =>  menu.addEventListener("click", (event)=>getNewsByTopic(event)));
let  searchButton  =  document.getElementById("search-button");

//1단계: 데이터 불러오기
const  getLatestNews  =  async ()=>{
	let  url  =  new  URL("https://api.newscatcherapi.com/v2/latest_headlines?countries=KR&page_size=10");
	let  header  =  new  Headers({'x-api-key':  'jEpQU7gtvsqfVBoonWBHX04JV7X59OuC9rncN4F8cK4'});
	let  response  =  await  fetch(url, {headers:  header}); 
	let  data  =  await  response.json(); 
	news  =  data.articles;
	render();
}; 
getLatestNews();

// 3단계: 카테고리 버튼 누르면 필터링할 수 있게 하자
const  getNewsByTopic  =  async (event)=> {
	let  topic  =  event.target.textContent.toLowerCase() let  url  =  new  URL(`https://api.newscatcherapi.com/v2/latest_headlines?countries=KR&page_size=10&topic=${topic}`)
	let  header  =  new  Headers({'x-api-key':  'jEpQU7gtvsqfVBoonWBHX04JV7X59OuC9rncN4F8cK4'});
	let  response  =  await  fetch(url, {headers:  header});
	let  data  =  await  response.json();
	news  =  data.articles;
	render();
}

// 4단계: 키워드 검색창과 버튼을 만들자
const  getNewsByKeyword  =  async()=>{
	let  keyword  =  document.getElementById("search-input").value;
	let  url  =  new  URL(`https://api.newscatcherapi.com/v2/search?q=${keyword}&page_size=10&countries=KR`);
	let  header  =  new  Headers({'x-api-key':  'jEpQU7gtvsqfVBoonWBHX04JV7X59OuC9rncN4F8cK4'});
	let  response  =  await  fetch(url, {headers:  header});
	let  data  =  await  response.json();
	news  =  data.articles;
	render();
};
searchButton.addEventListener("click", getNewsByKeyword); 

// 2단계: 가져온 데이터를 홈페이지에서 보여주기 - render()
const  render  = ()=>{
	let  newsHTML  =  "";
	newsHTML  =  news.map((item)=>{
	return  `<div class="row news">
		<div class="col-lg-4">
			<img class = "news-img-size" src ="${item.media}">
		</div>
		<div class="col-lg-8">
			<h2>
				${item.title}
			</h2>
			<p>
				${item.summary}
			</p>
			<div>
				${item.rights} * ${item.published_date}
			</div>
		</div>
	</div>`;
}).join('');

document.getElementById("news-board").innerHTML  =  newsHTML;
}
```
</details>

## 4. 코드 리펙토링
최대한 중복되는 코드를 줄인다. 당장 위의 코드만 봐도 겹치는 코드가 많다.   
```js
	let  url  =  new  URL(`URL명`);
	let  header  =  new  Headers({'x-api-key':  'jEpQU7gtvsqfVBoonWBHX04JV7X59OuC9rncN4F8cK4'});
	let  response  =  await  fetch(url, {headers:  header});
	let  data  =  await  response.json();
	news  =  data.articles;
	render();
```
이 코드만 봐도 필터링하느라 URL만 조금씩 다른거 빼고 나머지는 똑같은 코드가 전체 코드에서 3~4번씩 반복된다.    
반복을 막기 위해 각 필터링 함수에서는 url만 만들고, 뉴스를 불러오는 함수를 따로 만들어서 호출하도록 한다.
```js
let  url; //우선 url을 전역변수로 만들어야 에러가 안남

const  getNews  =  async ()=>{
	let  header  =  new  Headers({'x-api-key':  'jEpQU7gtvsqfVBoonWBHX04JV7X59OuC9rncN4F8cK4'});
	let  response  =  await  fetch(url, {headers:  header});
	let  data  =  await  response.json();  
	news  =  data.articles; 
	console.log(news);
	render();
}

const  getNewsByTopic  =  async (event)=> {
	let  topic  =  event.target.textContent.toLowerCase();
	url  =  new  URL(`https://api.newscatcherapi.com/v2/latest_headlines?countries=KR&page_size=10&topic=${topic}`);
	getNews();
};
//... 등등 이렇게 쭉쭉 필터링 함수 만들어준다. 
```
